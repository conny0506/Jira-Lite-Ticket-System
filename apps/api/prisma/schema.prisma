generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TicketStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TeamRole {
  MEMBER
  BOARD
  CAPTAIN
}

enum Department {
  SOFTWARE
  INDUSTRIAL
  MECHANICAL
  ELECTRICAL_ELECTRONICS
}

enum TicketReviewAction {
  APPROVED
  REJECTED
}

model Project {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tickets     Ticket[]
  assignments ProjectAssignment[]
}

model Ticket {
  id          String             @id @default(cuid())
  projectId   String
  title       String
  description String?
  dueAt       DateTime?
  status      TicketStatus       @default(TODO)
  priority    TicketPriority     @default(MEDIUM)
  completedAt DateTime?
  reviewNote  String?
  reviewedAt  DateTime?
  reviewedById String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  project     Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reviewedBy  TeamMember?        @relation("TicketReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  assignees   TicketAssignment[]
  submissions Submission[]
  reviews     TicketReview[]
}

model TeamMember {
  id               String       @id @default(cuid())
  name             String
  email            String       @unique
  passwordHash     String       @default("03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4")
  passwordResetTokenHash String?
  passwordResetExpiresAt DateTime?
  language         String       @default("tr")
  notificationEmailEnabled      Boolean @default(true)
  notificationAssignmentEnabled Boolean @default(true)
  notificationReviewEnabled     Boolean @default(true)
  lastLoginAt      DateTime?
  lastLoginIp      String?
  role             TeamRole     @default(MEMBER)
  isIntern         Boolean      @default(false)
  active           Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  ticketAssignments TicketAssignment[]
  projectAssignments ProjectAssignment[]
  submissions      Submission[]
  authSessions     AuthSession[]
  reviewedTickets  Ticket[]      @relation("TicketReviewedBy")
  ticketReviews    TicketReview[]
  loginAudits      LoginAudit[]
  meetingsCreated  Meeting[]
  departments      TeamMemberDepartment[]

  @@index([passwordResetTokenHash])
}

model TeamMemberDepartment {
  memberId    String
  department  Department
  assignedAt  DateTime   @default(now())
  member      TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([memberId, department])
  @@index([department])
}

model Meeting {
  id             String     @id @default(cuid())
  scheduledAt    DateTime
  meetingUrl     String
  note           String?
  includeInterns Boolean    @default(true)
  createdById    String
  reminderSentAt DateTime?
  canceledAt     DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  createdBy      TeamMember @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([scheduledAt, canceledAt])
  @@index([reminderSentAt])
}

model TicketAssignment {
  ticketId    String
  memberId    String
  assignedAt  DateTime   @default(now())
  seenAt      DateTime?
  ticket      Ticket     @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  member      TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([ticketId, memberId])
  @@index([memberId, seenAt])
}

model ProjectAssignment {
  projectId   String
  memberId    String
  assignedAt  DateTime   @default(now())
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  member      TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([projectId, memberId])
}

model Submission {
  id          String     @id @default(cuid())
  ticketId    String
  submittedById String
  fileName    String
  storageName String
  mimeType    String
  size        Int
  note        String?
  lateReason  String?
  createdAt   DateTime   @default(now())
  ticket      Ticket     @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  submittedBy TeamMember @relation(fields: [submittedById], references: [id], onDelete: Restrict)
}

model AuthSession {
  id               String     @id @default(cuid())
  memberId         String
  refreshTokenHash String     @unique
  expiresAt        DateTime
  revokedAt        DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  member           TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

model TicketReview {
  id          String             @id @default(cuid())
  ticketId    String
  reviewerId  String
  action      TicketReviewAction
  reason      String?
  createdAt   DateTime           @default(now())
  ticket      Ticket             @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  reviewer    TeamMember         @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model LoginAudit {
  id         String     @id @default(cuid())
  memberId   String
  ip         String?
  userAgent  String?
  createdAt  DateTime   @default(now())
  member     TeamMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, createdAt])
}

model MotivationalQuote {
  id        String   @id @default(cuid())
  text      String   @unique
  isActive  Boolean  @default(true)
  sortOrder Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}
